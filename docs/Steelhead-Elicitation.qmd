---
title: "Steelhead-Elicitation"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
```

# Steelhead Elicitation Results Round 1

```{r, echo = FALSE}
library(readr)
library(dplyr)
library(here)
library(ggplot2)
library(tidyr)
library(stringr)
library(viridis)
library(kableExtra)
```

```{r, echo = FALSE}
res1 = read_csv(here("docs/Steelhead STARS Elicitation Round 1.csv"), skip = 1,
                col_names = c("Time", "Name", 
                              "cov_surv_1", "rat_surv_1", "conf_surv_1",
                              "cov_surv_2", "rat_surv_2", "conf_surv_2",
                              "cov_surv_3", "rat_surv_3", "conf_surv_3",
                              "cov_surv_4", "rat_surv_4", "conf_surv_4",
                              "cov_rout_1", "rat_rout_1", "conf_rout_1",
                              "cov_rout_2", "rat_rout_2", "conf_rout_2",
                              "cov_rout_3", "rat_rout_3", "conf_rout_3",
                              "cov_rout_4", "rat_rout_4", "conf_rout_4",
                              "cov_time_1", "rat_time_1", "conf_time_1",
                              "cov_time_2", "rat_time_2", "conf_time_2",
                              "cov_time_3", "rat_time_3", "conf_time_3",
                              "cov_time_4", "rat_time_4", "conf_time_4",
                              "comments1", "comments2"
                                                                      ))
# rename confidence
results <- res1 %>%
  mutate(across(starts_with("cov"), ~as.factor(.))) %>%
  mutate(
    across(
      starts_with("conf"), 
      ~case_when(
        str_detect(., regex("Medium")) ~ "Medium",
        str_detect(., regex("Low")) ~ "Low",
        str_detect(., regex("High")) ~ "High",
        TRUE~.)
      )
    )

# just the comments for processing
comments <- results %>%
  select(Name, comments1, comments2)

# make results in a way easy to plot
results_r1 <- results %>%
  pivot_longer(
    cols = starts_with("conf") | starts_with("cov") | starts_with("rat"),
    names_to = "original_col_name",
    values_to = "temp_value"
  ) %>%
  separate(
    original_col_name,
    into = c("question", "metric", "region")) %>%
  pivot_wider(
    names_from = question,
    values_from = temp_value,
    id_cols = c(Name, metric, region)
  ) %>%
  rename(covariate = cov)

results_pc_r1 <- results_r1 %>%
  mutate(conf_val = case_when(conf== "Low" ~ 1L,
                              conf == "Medium" ~ 2L, 
                              conf == "High" ~ 3L,
                              TRUE~0L))%>%
  group_by(metric, region, covariate) %>%
  summarize(resp = n(),
            med_conf = median(conf_val)) %>%
  ungroup() %>%
  complete(region, 
           nesting(covariate, metric),
           fill = list(resp = 0)) %>%
  mutate(total = 16,
         prop = round(resp/total,2)) %>%
  filter(!(is.na(covariate) & resp ==0)) %>%
  mutate(metric = case_when(metric == "surv"~"Survival",
                            metric == "rout"~"Routing",
                            metric == "time"~"TravelTime",
                            TRUE~metric),
         metric = factor(metric, levels = c("Survival", "Routing","TravelTime"))) 

results_pc_r1_conf <- results_r1 %>%
  filter(conf != "Low") %>%
  group_by(metric, region) %>%
  mutate(total = n()) %>%
  ungroup() %>%
  group_by(metric, region, covariate, total) %>%
  summarize(resp = n()) %>%
  ungroup() %>%
  complete(region, 
           nesting(covariate, metric),
           fill = list(resp = 0)) %>%
  mutate(prop = round(resp/total,2),
         prop = replace(prop, is.na(prop), 0)) %>%
  filter(!(is.na(covariate) & resp ==0)) 
```


## Regions

![STARS regions](stars_regions.png)

## Region 1 Covariates

```{r , fig.cap = "Survival Results"}
ggplot(results_pc_r1 %>% filter(region == 1)) + 
  geom_col(aes(metric, resp, fill = covariate), color = "black") +
  scale_fill_viridis(discrete = T, option = "plasma", direction = -1) +
  theme_bw()
```

```{r}
kable(results_pc_r1 %>% filter(region == 1) %>% select(metric, covariate, prop, med_conf) %>% arrange(metric),
      label = NA,
      vline = "",
      caption = "Covariates for Region 1 by Metric",
      valign = "t") %>%
  kable_classic(html_font = "Cambria") %>%
      row_spec(c(3,6,9),extra_css = "border-bottom: 1px solid;") %>%
  row_spec(row = 0, bold = TRUE) %>%
    kable_styling(full_width = F) 
```

-   Reached consensus for all metrics

### Rationale

#### Survival

#### Routing

#### Travel Time


## Region 2 Covariates

```{r, fig.cap = "Routing Results"}
ggplot(results_pc_r1 %>% filter(region == 2)) + 
  geom_col(aes(metric, resp, fill = covariate), color = "black") +
  scale_fill_viridis(discrete = T, option = "mako", direction = -1) +
  theme_bw()
```

```{r}
kable(results_pc_r1 %>% filter(region == 2) %>% select(metric, covariate, prop, med_conf) %>%arrange(metric),
      label = NA,
      vline = "",
      caption = "Covariates for Region 2",
      valign = "t") %>%
    kable_classic(html_font = "Cambria") %>%
      row_spec(c(3,6,9),extra_css = "border-bottom: 1px solid;") %>% kable_styling(full_width = F) %>%
  row_spec(row = 0, bold = TRUE) 

```

- Did not reach consensus on any metrics 

### Rationale

#### Survival

#### Routing

#### Travel Time

## Region 3 Covariates

```{r , fig.cap = "Region 3 Results"}
ggplot(results_pc_r1 %>% filter(region == 3)) + 
  geom_col(aes(metric, resp, fill = covariate), color = "black") +
  scale_fill_viridis(discrete = T, option = "turbo", direction = -1) +
  theme_bw()
```


```{r}
kable(results_pc_r1 %>% filter(region == 3) %>% select(metric, covariate, prop, med_conf) %>% arrange(metric),
      label = NA,
      vline = "",
      caption = "Covariates for Region 3",
      valign = "t") %>%
  kable_styling(full_width = F) %>%
  kable_classic(html_font = "Cambria") %>%
      row_spec(c(3,6,9),extra_css = "border-bottom: 1px solid;") %>%
  row_spec(row = 0, bold = TRUE) 
```

- No consensus for any metrics
### Rationale

#### Survival

#### Routing

#### Travel Time

## Region 4 Covariates

```{r , fig.cap = "Region 4 Results"}
ggplot(results_pc_r1 %>% filter(region == 4)) + 
  geom_col(aes(metric, resp, fill = covariate), color = "black") +
  scale_fill_viridis(discrete = T, option = "magma", direction = -1) +
  theme_bw()
```
### Rationale

#### Survival

#### Routing

#### Travel Time


```{r}
kable(results_pc_r1 %>% filter(region == 4) %>% select(metric, covariate, prop, med_conf) %>% arrange(metric),
      label = NA,
      vline = "",
      caption = "Covariates for Region 4",
      valign = "t") %>%
  kable_styling(full_width = F) %>%
  kable_classic(html_font = "Cambria") %>%
      row_spec(c(3,7,10),extra_css = "border-bottom: 1px solid;") %>%
  row_spec(row = 0, bold = TRUE) 
```

- Reached consensus for Travel Time

## Resources

- A Shiny app is available that would allow others in the group to see how exports, SJR inflows and OMR flows influence hydrodynamic conditions in each of these regions. Many participants may not be familiar with these data.
- Perry et al. 2018
- Buchanan et al. 2021
- Pope et al. 2025
- Buchanan and Whitlock (2022): temperature was better supported than Delta inflow for FR Chinook; correlation between temperature and flow
- Cavallo et al. 2015
- Buchanan, R.A., Skalski, J.R. Relating survival of fall-run Chinook Salmon through the San Joaquin Delta to river flow. 
- Hydrodynamics minimally affected by exports and OMR (Cavallo et al. 2013, Cavallo, B., P. Gaskill and J. Melgo 2013, Cramer report 
- USFWS reports 2021, 2022, 2024; 2025)
- South Delta steelhead survival studies (Matthias et al.) - 2011
- Buchanan 2024

- 2024 CAMT Salmon Technical Working Group Final Report "a Review of Recent Science to Improve Our Understanding and Application of Life Cycle and Decision Support Models to Salmon Management in the South Delta"; Buchanan steelhead routing presentation June 2025; Buchanan et al. 2021; Pope et al. 2025; Buchanan and Whitlock 2022
Reclamation LTO FEIS Appendix I Old and Middle River Flow Management Attachment I.3 Delta Export Zone of Influence Analysis


## Topics to be discussed 

- On what basis should we determine "primary covariate"?
- 1. (Question about Pope et al 2025) NMFS would welcome some discussion about Region 2 and Region 4. Region 2 appears to overlap Region 4 from the export facilities north to HWY 4 – do survivals and travel times between those receivers contribute to relationships in both regions? Is there an assumed direction for transiting Region 4? Is it correct that fish that enter the mainstem San Joaquin River through the mouths of Middle or Old River (NOT via Turner Cut) do not contribute to transit success of Region 4? 
- 2. Comment: There is no current commitment or regulatory requirement for any barrier (rock or non-physical) at Head of Old River (HOR). So, NMFS assessed the explanatory value of the various covariates within the “barrier out” panels of figures. However, NMFS wonders if this ends up ignoring (a) much of the AT data which may have been conducted with the barrier in, and (b) much of the “more usual” Vernalis flows, i.e. <5,000 cfs which, under past regulatory regimes, would be associated with “barrier in”. What did other experts think about barrier status? 


## Caveats/Suggestions

- Likely more options need to be considered or within variable wet/normal/dry scenarios
- Tidal flow should be considered as the primary covariate for region 3.
- Might it be reasonable to make competing predictions using competing covariates in some reaches, if the model set was restrained to just a couple of alternatives? The user would then select which model to use (e.g., OMR-driven dynamics in Region 4 vs export-driven dynamics in Region 4).
- Covariates should be ranked primarily on their mechanistic basis and the strength of that physical effect in the region of interest. For example, if the expected effect of exports is altered hydrodynamics, exports should not be considered as a covariate in regions where exports do appreciably change hydrodynamic conditions experienced and perceived by fish. Should be an option to have none of these three environmental covariates in regions where none of a clear, strong mechanistic effect.
- All responses are within the context of "modern" operations post-2009 under the conditions observed in literature cited. I am uncertain of what the primary covariate would be if operations were significantly changed during juvenile salmonid outmigration period. There are many factors, if significantly modified may impact survival and routing-- installation of barriers, habitat restoration improvements to facilities, significant increases or decreases of pumping rates, predator control measures, changes to trucking and release operations. For example, if water exports were always at maximum capacity or significantly more negative than -5,000 OMR Index, exports and OMR more likely to influence routing than under modern conditions. Exports and OMR could become increasingly more of important covariate on survival in those regions that are close in proximity to export facilities. I'm uncertain if it would be more of negative impact on survival or positive impact on survival. Under poor conditions, perhaps it would increase survival by through the salvage operations, fish would get a free ride to a better environment like we have seen in some chinook salmon studies. However, the salvage operations are most efficient at a specific rate--not too fast and not too slow. 
- Probably more relevant for chinook: My hypothesis that the salvage operations route probably increases survival of fry-size chinook during wet years. We observe a lot of fry-size chinook in salvage during wet years. Most of salmonid observations for these routing and survival studies are based on smolt-sized fish that are large enough to be acoustically tagged.

## Concerns

- I am concerned that the published paper is confining the expert elicitation. It seems that experts should be consulted prior to modeling to establish the proposed hypotheses and mechanisms. Both the model structure and predictor variables could be quite different with such an exercise. I think response variables may also be reduced. For example, would we mange for reduced travel time if it doesn't help survival? What about routing?